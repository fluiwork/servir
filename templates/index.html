<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servientrega</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        @media (max-width: 768px) {
            .main-content {
                height: 40vh !important;
                min-height: 430px !important;
            }
        }
        /* small helper so loading overlay centers correctly if flex wasn't applied via CSS */
        #loadingScreen { display: none; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="img/logo-servientrega-blanco.svg" alt="">
            </div>
            <nav class="nav-menu desktop-only">
                <a href="#">Rastrear</a>
                <a href="#">Cotizar</a>
                <a href="#">Recoger</a>
                <a href="#">Soluciones</a>
                <a href="#">Nuestra red</a>
            </nav>
            <button class="login-btn desktop-only">Ingresar</button>
        </div>
    </header>
     <div class="main-content" style="background-color: #f5f5f5; padding: 0; width: 100%;">
            <div class="content-left">
                <div class="pink-line"></div>
                <div class="content-text">
                    <h1 class="main-title">Conoce nuestras líneas de atención</h1>
                    <button class="contact-btn">Contacto</button>
                </div>
            </div>
            <div class="content-right">
              <img src="img/pagina.png" style="width: 70%;" alt="" id="heroImage">
            </div>
        </div>

    <!-- Main Content -->
    <main style="background-color: white;">
        <!-- Search Section Desktop -->
        <div class="search-section">
            <form class="search-form" id="searchFormDesktop">
                <label class="search-label">Consultar</label>
                <select class="search-select">
                    <option>Envíos</option>
                    <option>Rastreo</option>
                    <option>Cotización</option>
                </select>
                <input type="text" class="search-input" id="searchInputDesktop" placeholder="Ingresa el # de guía">
                <button type="submit" class="search-btn" id="searchBtnDesktop">
                    <i class="fas fa-arrow-right"></i>
                </button>
            </form>
        </div>

        <!-- Search Section Mobile -->
        <div class="consultar-container">
            <div class="consultar-header">
                <h2 class="consultar-title">Consultar</h2>
                <div class="consultar-form">
                    <div class="dropdown-container">
                        <select class="dropdown-select" id="enviosSelect">
                            <option value="envios">Envíos</option>
                            <option value="paquetes">Paquetes</option>
                            <option value="documentos">Documentos</option>
                        </select>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </div>
                    <div class="input-container">
                        <input type="text" class="search-input" placeholder="Ingresa el # de guía" id="searchInput">
                    </div>
                    <button type="button" class="search-button" id="searchBtnMobile">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Services Section -->
        <div class="services-section">
            <h2 class="services-title" style="padding-top: 5%;">Conoce nuestras soluciones logísticas</h2>
            <div class="services-grid">
                <div class="service-card">
                    <img src="img/ico-big-transporte-entrega.svg" alt="">
                    <h3 class="service-title">Transporte y Entrega | Soluciones Logísticas | Servientrega</h3>
                    <p class="service-description">Recogemos en tu puerta y entregamos en el tiempo que requieras.</p>
                    <a href="#" class="service-link">Ver más <i class="fas fa-arrow-right"></i></a>
                </div>
                <div class="service-card">
                    <img src="img/ico-big-soluciones-logistica.svg" alt="">
                    <h3 class="service-title">Soluciones Logísticas Eficientes</h3>
                    <p class="service-description">Optimizamos tu logística para campañas y tu almacenamiento.</p>
                    <a href="#" class="service-link">Ver más <i class="fas fa-arrow-right"></i></a>
                </div>
                <div class="service-card">
                    <img src="img/ico-digitales.svg" alt="">
                    <h3 class="service-title">Soluciones Digitales | Innovación y Tecnología Logística</h3>
                    <p class="service-description">Entregas electrónicas, SMS, email masivo y más para publicidad, legales y otros.</p>
                    <a href="#" class="service-link">Ver más <i class="fas fa-arrow-right"></i></a>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Screen -->
    <div id="loadingScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div style="text-align: center; color: white;">
            <i class="fas fa-spinner fa-spin" style="font-size: 50px; margin-bottom: 20px;"></i>
            <p id="loadingText">Cargando información...</p>
        </div>
    </div>

<script>
/*
  Robust index.js logic:
  - Clears previous result when a new search starts (evita datos estáticos viejos).
  - Usa fetch con cache: 'no-store' + AbortController timeout.
  - Sólo guarda sessionStorage.rastroResult cuando resultado.success === true.
  - Console logs para debug.
*/

/* Ajusta aquí la URL pública de tu tunnel (cloudflared) si tu frontend está en otro dominio.
   Si sirves frontend y backend en el mismo host puedes dejar '' para usar rutas relativas.
*/
const API_BASE = 'http://127.0.0.1:5000'; // <-- reemplaza por tu dominio público o deja '' si está en el mismo origen

function showLoading(message) {
    const overlay = document.getElementById('loadingScreen');
    const loadingText = document.getElementById('loadingText');
    if (message) loadingText.textContent = message;
    overlay.style.display = 'flex';
    overlay.style.flexDirection = 'column';
}

function hideLoading() {
    const overlay = document.getElementById('loadingScreen');
    overlay.style.display = 'none';
}

function validateNumero(numero) {
    if (!numero) return 'Debes ingresar un número de guía';
    if (!/^\d+$/.test(numero)) return 'El número de guía debe contener solo dígitos';
    return null;
}

async function sendRastrear(numero) {
    const url = (API_BASE && API_BASE.length) ? `${API_BASE}/rastrear` : '/rastrear';

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 120000); // 120s timeout

    try {
        console.debug('[rastrear] POST ->', url, 'numero:', numero);
        const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ numero_guia: numero }),
            signal: controller.signal,
            cache: 'no-store', // evitar respuestas cacheadas
            // credentials: 'same-origin' // si necesitas cookies, descomenta
        });

        clearTimeout(timeout);

        // Verificar status
        const text = await resp.text(); // leemos texto primero para manejar JSON o no-JSON
        let parsed;
        try {
            parsed = text ? JSON.parse(text) : null;
        } catch (e) {
            console.error('[rastrear] respuesta no JSON:', text);
            throw new Error('Respuesta inválida del servidor (no JSON). Revisa logs del backend.');
        }

        if (!resp.ok) {
            const errMsg = (parsed && parsed.error) ? parsed.error : `Error en la petición: ${resp.status}`;
            throw new Error(errMsg);
        }

        // parsed ahora es JSON
        return parsed;
    } catch (err) {
        clearTimeout(timeout);
        if (err.name === 'AbortError') {
            throw new Error('El servidor está tardando demasiado. Intenta de nuevo en unos segundos.');
        }
        throw err;
    }
}

// Helper: start a search (shared by desktop and mobile)
async function startSearch(numero) {
    const err = validateNumero(numero);
    if (err) { alert(err); return; }

    // Limpieza de cualquier resultado viejo PARA EVITAR que detalle.html muestre datos estáticos antiguos
    try {
        sessionStorage.removeItem('rastroResult');
        sessionStorage.removeItem('rastroNumero');
    } catch (e) {
        console.warn('[rastrear] no se pudo limpiar sessionStorage:', e);
    }

    showLoading('Cargando información...');

    try {
        const resultado = await sendRastrear(numero);

        if (!resultado) {
            hideLoading();
            alert('Respuesta vacía del servidor');
            return;
        }

        // Si backend devuelve success === true, guardar y redirigir
        if (resultado.success === true) {
            try {
                sessionStorage.setItem('rastroResult', JSON.stringify(resultado));
                sessionStorage.setItem('rastroNumero', numero);
                console.debug('[rastrear] Resultado guardado en sessionStorage');
            } catch (e) {
                console.error('[rastrear] error guardando sessionStorage', e);
                hideLoading();
                alert('Error guardando resultado en el navegador.');
                return;
            }

            // Redirigir a detalle.html tras un breve delay para asegurar que storage esté listo
            hideLoading();
            window.location.href = 'detalle.html';
            return;
        } else {
            // Backend devolvió success false -> mostrar el error y no redirigir ni guardar
            hideLoading();
            const errText = resultado.error || 'No se encontró información para este número de guía.';
            alert(errText);
            return;
        }

    } catch (err) {
        hideLoading();
        console.error('[rastrear] error durante la búsqueda:', err);
        alert(err.message || 'Error desconocido durante la búsqueda');
    }
}

// Desktop form submit
document.addEventListener('DOMContentLoaded', function () {
    const formDesktop = document.getElementById('searchFormDesktop');
    if (formDesktop) {
        formDesktop.addEventListener('submit', function (e) {
            e.preventDefault(); // evitar recarga
            const input = document.getElementById('searchInputDesktop');
            const numero = input ? input.value.trim() : '';
            startSearch(numero);
        });
    }

    // Mobile button handler
    const btnMobile = document.getElementById('searchBtnMobile');
    if (btnMobile) {
        btnMobile.addEventListener('click', function () {
            const input = document.getElementById('searchInput');
            const numero = input ? input.value.trim() : '';
            startSearch(numero);
        });
    }

    // Optionally, clear stale result on initial load to avoid showing old data if user opens detalle directly
    // (comentado porque podría no ser deseado). Si quieres forzar la limpieza al cargar index,
    // descomenta las dos líneas siguientes:
    // try { sessionStorage.removeItem('rastroResult'); sessionStorage.removeItem('rastroNumero'); } catch(e){}
});
</script>

</body>
</html>
