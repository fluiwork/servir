<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servientrega</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/detalle.css">
    <style>
        @media (max-width: 768px) {
            .main-content {
                height: 40vh !important;
                min-height: 430px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="img/logo-servientrega-blanco.svg" alt="">
            </div>
            <nav class="nav-menu desktop-only">
                <a href="#">Rastrear</a>
                <a href="#">Cotizar</a>
                <a href="#">Recoger</a>
                <a href="#">Soluciones</a>
                <a href="#">Nuestra red</a>
            </nav>
            <button class="login-btn desktop-only">Ingresar</button>
        </div>
    </header>
     
    <!-- Main Content -->
    <main style="background-color: white;">
   <div class="tracking-container">
  <!-- Progress Steps -->
  <div class="progress-steps" id="progressSteps">
    <div class="step" data-step="RECIBIDO">
      <div class="step-circle">1</div>
      <div class="step-label">RECIBIDO</div>
    </div>
    <div class="step-line"></div>
    <div class="step" data-step="EN RUTA">
      <div class="step-circle">2</div>
      <!-- Texto fijo en HTML para evitar parpadeos al cargar -->
      <div class="step-label">PRESENTA NOVEDAD</div>
    </div>
    <div class="step-line"></div>
    <div class="step" data-step="ENTREGADO">
      <div class="step-circle">3</div>
      <div class="step-label">ENTREGADO</div>
    </div>
  </div>

  <!-- Main Card -->
  <div class="tracking-card">
    <!-- Header -->
    <div class="tracking-header">
      <div class="header-left">
        <div class="truck-icon">
          <img src="img/result3.png" style="width: 70%;" alt="">
        </div>
        <!-- Texto fijo en HTML para evitar parpadeos al cargar -->
        <h2 class="status-title" id="statusTitle">PRESENTA NOVEDAD</h2>
      </div>
      <div class="header-right">
        <div class="guide-label">Número de la guía</div>
        <div class="guide-number" id="guideNumber">—</div>
      </div>
    </div>

    <!-- Modify Button -->
    <button class="modify-btn">SOLUCIONAR NOVEDAD</button>

    <!-- Shipping Details -->
    <div class="shipping-details">
      <div class="detail-item">
        <div class="detail-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
        </div>
        <div>
          <div class="detail-label">Ciudad de Recogida</div>
          <div class="detail-value" id="ciudadRecogida">—</div>
        </div>
      </div>

      <div class="detail-item">
        <div class="detail-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
        </div>
        <div>
          <div class="detail-label">Ciudad de Destino</div>
          <div class="detail-value" id="ciudadDestino">—</div>
        </div>
      </div>

      <div class="detail-item">
        <div>
          <div class="detail-label">Régimen</div>
          <div class="detail-value" id="regimen">—</div>
        </div>
      </div>

      <div class="detail-item">
        <div>
          <div class="detail-label">Cantidad Envíos</div>
          <div class="detail-value" id="cantidadEnvios">—</div>
        </div>
      </div>
    </div>

    <!-- History Section -->
    <div class="history-section">
      <h3 class="history-title">HISTORIAL</h3>

      <div class="timeline" id="timelineContainer">
        <!-- El contenido del historial se insertará aquí dinámicamente -->
      </div>
    </div>
  </div>
</div>

    </main>

<script>
/*
  Cambios mínimos: forcear texto fijo "PRESENTA NOVEDAD" en statusTitle y en la etiqueta
  del paso correspondiente (data-step === 'EN RUTA').
  El resto de la lógica del historial y fetch permanece igual.
*/

const API_BASE = ''; // deja '' para rutas relativas

function createTimelineItem(index, fecha, hora, descripcion, isActive) {
    const numberClass = isActive ? 'timeline-number active' : 'timeline-number inactive';
    const esc = (s) => {
        if (!s && s !== 0) return '';
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    };
    return `
      <div class="timeline-item">
        <div class="${numberClass}">${esc(index)}</div>
        <div class="timeline-content">
          <div class="timeline-header">
            <span class="timeline-date">${esc(fecha)}</span>
            <span class="timeline-time">${esc(hora)}</span>
          </div>
          <div class="timeline-text">${esc(descripcion)}</div>
        </div>
      </div>
    `;
}

function setProgressState(estado) {
    const steps = document.querySelectorAll('#progressSteps .step');
    steps.forEach(s => s.classList.remove('completed','active'));
    if (!estado) return;
    const e = estado.toUpperCase();

    if (e === 'ENTREGADO') {
        steps.forEach(s => s.classList.add('completed'));
    } else if (e === 'EN RUTA' || e.includes('EN RUTA')) {
        steps.forEach((s, idx) => {
            if (idx === 0) s.classList.add('completed');
            if (idx === 1) s.classList.add('active');
        });
    } else if (e === 'RECIBIDO') {
        steps.forEach((s, idx) => {
            if (idx === 0) s.classList.add('active');
        });
    } else {
        // desconocido: no cambiar
    }
}

/*
  Modificada: ahora esta función **no** escribirá etiquetas dinámicas desde el backend.
  En su lugar forcea que la etiqueta del paso 'EN RUTA' diga "PRESENTA NOVEDAD".
  Esto evita que el texto cambie aunque payload tenga otro valor.
*/
function updateStepLabelsToFixed() {
    const steps = document.querySelectorAll('#progressSteps .step');
    steps.forEach(s => {
        // mantener los textos por defecto en otras etiquetas
        const labelEl = s.querySelector('.step-label');
        // no tocar las demás labels aquí
    });

    // Forzar que el paso con data-step 'EN RUTA' muestre "PRESENTA NOVEDAD"
    const enRutaStep = Array.from(steps).find(s => (s.dataset.step || '').toUpperCase() === 'EN RUTA');
    if (enRutaStep) {
        const labelEl = enRutaStep.querySelector('.step-label');
        if (labelEl) labelEl.textContent = 'PRESENTA NOVEDAD';
    }
}

function looksLikeStaticHist(historial) {
    if (!Array.isArray(historial) || historial.length === 0) return false;
    const sample = historial.map(h => (h.descripcion || '').toLowerCase()).join(' ');
    const staticPhrases = [
        'ingreso al centro logistico',
        'entrega verificada',
        'en zona de distribucion',
        'salio a ciudad destino',
        'centro logistico'
    ];
    return staticPhrases.some(p => sample.includes(p));
}

function populateFromPayload(payload, numeroGuardado) {
    try {
        // Forzar statusTitle a texto fijo
        document.getElementById('guideNumber').textContent = payload.numeroGuia || numeroGuardado || '—';
        document.getElementById('statusTitle').textContent = 'PRESENTA NOVEDAD';
        document.getElementById('ciudadRecogida').textContent = payload.ciudadRecogida || '—';
        document.getElementById('ciudadDestino').textContent = payload.ciudadDestino || '—';
        document.getElementById('regimen').textContent = payload.regimen || '—';
        document.getElementById('cantidadEnvios').textContent = payload.cantidadEnvios || '—';

        // Actualizar paso visual (clases) según estado real, pero no cambiar labels
        setProgressState(payload.estado);
        // Forzar la label fija del paso EN RUTA
        updateStepLabelsToFixed();

        const timeline = document.getElementById('timelineContainer');
        timeline.innerHTML = '';

        const historial = Array.isArray(payload.historial) ? payload.historial.slice() : [];
        // ordenar ascendente por numero (más antiguo primero)
        historial.sort((a,b) => {
            const na = Number(a.numero || 0);
            const nb = Number(b.numero || 0);
            return na - nb;
        });

        // Mostrar en orden cronológico ascendente (más antiguo arriba). 
        // Marcar el último (más reciente) como active.
        if (historial.length === 0) {
            timeline.innerHTML = '<p style="color:#666;">No hay historial disponible</p>';
        } else {
            historial.forEach((evt, idx) => {
                const isActive = (idx === (historial.length - 1)); // último elemento = más reciente
                const indexDisplay = evt.numero || (idx + 1);
                timeline.insertAdjacentHTML('beforeend', createTimelineItem(indexDisplay, evt.fecha, evt.hora, evt.descripcion, isActive));
            });
        }
    } catch (e) {
        console.error('Error llenando la vista desde payload:', e);
        document.getElementById('timelineContainer').innerHTML = '<p style="color:#666;">Error mostrando historial</p>';
    }
}

async function fetchFresh(numero) {
    if (!numero) return null;
    try {
        console.debug('[detalle] solicitando re-fetch para guía', numero);
        const url = (API_BASE && API_BASE.length) ? `${API_BASE}/rastrear` : '/rastrear';
        const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ numero_guia: numero }),
            cache: 'no-store'
        });
        const json = await resp.json();
        if (json && json.success === true && json.data) {
            try {
                sessionStorage.setItem('rastroResult', JSON.stringify(json));
                sessionStorage.setItem('rastroNumero', numero);
            } catch (e) {
                console.warn('[detalle] no se pudo actualizar sessionStorage tras re-fetch:', e);
            }
            return json;
        } else {
            console.warn('[detalle] re-fetch no devolvió éxito:', json && json.error ? json.error : resp.status);
            return null;
        }
    } catch (e) {
        console.error('[detalle] error en fetchFresh:', e);
        return null;
    }
}

document.addEventListener('DOMContentLoaded', async function () {
    // Asegurarse al inicio que la etiqueta EN RUTA muestre PRESENTA NOVEDAD aunque no haya JS cargado aún
    updateStepLabelsToFixed();
    document.getElementById('statusTitle').textContent = 'PRESENTA NOVEDAD';

    // Asignar comportamiento del botón para redirigir a datos.html
    const modifyBtn = document.querySelector('.modify-btn');
    if (modifyBtn) {
        modifyBtn.addEventListener('click', function () {
            window.location.href = 'datos.html';
        });
    }

    let raw = sessionStorage.getItem('rastroResult');
    const numeroGuardado = sessionStorage.getItem('rastroNumero') || '';

    if (!raw) {
        const urlParams = new URLSearchParams(window.location.search);
        const numeroParam = urlParams.get('numero') || numeroGuardado || '';
        if (!numeroParam) {
            window.location.href = 'index.html';
            return;
        }
        const fresh = await fetchFresh(numeroParam);
        if (fresh && fresh.data) {
            raw = sessionStorage.getItem('rastroResult');
        } else {
            window.location.href = 'index.html';
            return;
        }
    }

    let parsed;
    try {
        parsed = JSON.parse(raw);
    } catch (e) {
        console.error('Error parseando rastroResult', e);
        const numeroParam = (new URLSearchParams(window.location.search).get('numero')) || numeroGuardado || '';
        if (numeroParam) {
            const fresh = await fetchFresh(numeroParam);
            if (fresh && fresh.data) {
                parsed = fresh;
            } else {
                window.location.href = 'index.html';
                return;
            }
        } else {
            window.location.href = 'index.html';
            return;
        }
    }

    const payload = (parsed && parsed.data) ? parsed.data : (parsed || {});
    const currentNumero = payload.numeroGuia || numeroGuardado || '';

    if (looksLikeStaticHist(payload.historial)) {
        console.debug('[detalle] historial parece estático, intentando re-fetch con numero', currentNumero);
        const fresh = await fetchFresh(currentNumero);
        if (fresh && fresh.data) {
            const freshPayload = fresh.data;
            populateFromPayload(freshPayload, currentNumero);
            return;
        } else {
            console.debug('[detalle] re-fetch no trajo datos nuevos, usando payload existente');
        }
    }

    populateFromPayload(payload, currentNumero);
});
</script>

</body>
</html>
